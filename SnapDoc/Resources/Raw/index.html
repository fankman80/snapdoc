<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAdmin Map</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #popup {
            position: absolute;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.5);
            width: 250px;
            font-family: "Aptos", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            display: none;
            word-wrap: break-word;
            z-index: 9999;
            border: 1px solid gray;
        }

        #popupContent {
            margin-bottom: 10px;
        }

        #sendButton {
            display: block;
            margin-left: auto;
            margin-right: 0;
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            background-color: #999999;
            color: #fff;
            cursor: pointer;
        }

        #popup::before {
            content: "";
            position: absolute;
            left: -11px;
            top: 40px;
            border-top: 11px solid transparent;
            border-bottom: 11px solid transparent;
            border-right: 11px solid gray;
        }

        #popup::after {
            content: "";
            position: absolute;
            left: -10px;
            top: 41px;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid white;
        }

        #popup h4 {
            font-weight: bold;
            margin: 5px;
            color: #999999;
        }

        #popup p {
            margin: 5px 5px 15px 5px;
        }

        .popup-header {
            font-size: 14px;
            margin: 5px;
        }

        hr.solid {
            border: none;
            border-top: 1px solid #999999;
            margin: 10px 0;
        }

        .ol-scale-line {
            background: rgba(255,255,255,1);
            border: 1px solid #999;
            border-radius: 4px;
            padding: 2px 8px;
            bottom: 14px;
            left: 10px;
            font-family: "Aptos", "Segoe UI", sans-serif;
            font-size: 14px;
            color: #333;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ol-zoom, .ol-rotate {
            border: 1px solid #999;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.8);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ol-zoom {
            top: 10px;
            left: 10px;
        }

        .ol-rotate {
            top: 120px;
            right: 10px;
        }

        .measure-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
        }

            .measure-buttons button {
                background: white;
                border: 1px solid #999;
                border-radius: 4px;
                padding: 6px 8px;
                cursor: pointer;
                font-size: 13px;
                font-family: "Segoe UI", sans-serif;
                box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            }

                .measure-buttons button.active {
                    background: #999999;
                    color: white;
                }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="popup">
        <div id="popupContent"></div>
        <button id="sendButton">Bearbeiten</button>
    </div>

    <div class="measure-buttons">
        <button id="measureDistance">Distanz messen</button>
        <button id="measureArea">Fläche messen</button>
        <button id="clearMeasure">Löschen</button>
    </div>

    <script>
        let map, vectorSource, vectorLayer, wmsLayer, measureSource, measureLayer;
        let mapReady = false;
        let pendingPositions = [];
        let currentPinkey = null, currentPlankey = null;
        let initialCenter = [0, 0], initialZoom = 1, initialIcon = 'https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg', initialIconScale = 1;

        function initMarkersFromBridge(center, zoom, icon, scale, markers) {
            initialCenter = center; initialZoom = zoom; initialIcon = icon; initialIconScale = scale;
            if (!map) initMap();
            if (markers && markers.length > 0) setMultipleMarkers(markers);
        }

        function initMap() {
            wmsLayer = new ol.layer.Tile({
                source: new ol.source.TileWMS({
                    url: 'https://wms.geo.admin.ch/',
                    params: { LAYERS: 'ch.swisstopo.pixelkarte-farbe', TILED: true },
                    serverType: 'mapserver'
                })
            });

            map = new ol.Map({
                target: 'map',
                layers: [wmsLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat(initialCenter),
                    zoom: initialZoom
                })
            });

            // Maßstabsleiste
            map.addControl(new ol.control.ScaleLine({ units: 'metric', bar: false, steps: 6, text: true, minWidth: 80, maxWidth: 140 }));

            vectorSource = new ol.source.Vector();
            vectorLayer = new ol.layer.Vector({ source: vectorSource });
            map.addLayer(vectorLayer);

            measureSource = new ol.source.Vector();
            measureLayer = new ol.layer.Vector({
                source: measureSource,
                style: function (feature) {
                    const geom = feature.getGeometry();
                    let text = '';
                    if (geom instanceof ol.geom.LineString) {
                        const length = ol.sphere.getLength(geom);
                        text = length > 1000 ? (length / 1000).toFixed(2) + ' km' : length.toFixed(2) + ' m';
                    } else if (geom instanceof ol.geom.Polygon) {
                        const area = ol.sphere.getArea(geom);
                        text = area > 10000 ? (area / 1000000).toFixed(2) + ' km²' : area.toFixed(2) + ' m²';
                    }

                    return new ol.style.Style({
                        fill: new ol.style.Fill({ color: 'rgba(255,255,255,0.4)' }),
                        stroke: new ol.style.Stroke({ color: '#999999', width: 3 }),
                        image: new ol.style.Circle({ radius: 5, fill: new ol.style.Fill({ color: '#999999' }) }),
                        text: new ol.style.Text({
                            text: text,
                            placement: geom instanceof ol.geom.Polygon ? 'point' : 'line',
                            font: 'bold 14px Segoe UI',
                            fill: new ol.style.Fill({ color: '#fff' }),
                            stroke: new ol.style.Stroke({ color: '#333', width: 3 }),
                            overflow: true
                        })
                    });
                }
            });

            map.addLayer(measureLayer);

            const popupElement = document.getElementById('popup');
            const popupContent = document.getElementById('popupContent');
            const popup = new ol.Overlay({ element: popupElement, positioning: 'bottom-center', stopEvent: true, offset: [30, -50] });
            map.addOverlay(popup);

            // Pins verschiebbar
            var modify = new ol.interaction.Modify({
                hitDetection: vectorLayer,
                source: vectorSource
            });
            map.addInteraction(modify);

            mapReady = true;

            if (pendingPositions.length > 0) {
                pendingPositions.forEach(p => setMarkerPosition(p.lon, p.lat, p.pinname, p.pinlocation, p.pindesc, p.plankey, p.pinkey));
                pendingPositions = [];
            }

            // Klick auf Pin → Popup
            map.on('click', function (evt) {
                const feature = map.forEachFeatureAtPixel(evt.pixel, f => f);
                if (feature && feature.get('pinname') !== undefined) {
                    const coordinates = feature.getGeometry().getCoordinates();
                    currentPinkey = feature.get('pinkey');
                    currentPlankey = feature.get('plankey');

                    let content = '';
                    if (feature.get('pinname')) content += `<h4 class="popup-header">Bezeichnung:</h4><p>${feature.get('pinname')}</p><hr class="solid">`;
                    if (feature.get('pinlocation')) content += `<h4 class="popup-header">Standort:</h4><p>${feature.get('pinlocation')}</p><hr class="solid">`;
                    if (feature.get('pindesc')) content += `<h4 class="popup-header">Beschreibung:</h4><p>${feature.get('pindesc')}</p>`;

                    if (!content) content = `<h4 class="popup-header">Hinweis:</h4><p>Für diesen Pin sind noch keine Informationen verfügbar.</p>`;
                    else content = content.replace(/<hr class="solid">$/, '');

                    popupContent.innerHTML = content;
                    popupElement.style.display = 'block';
                    popup.setPosition(coordinates);
                } else {
                    popupElement.style.display = 'none';
                    currentPinkey = null; currentPlankey = null;
                }
            });

            // Messwerkzeuge
            let draw = null;
            function removeDraw() { if (draw) { map.removeInteraction(draw); draw = null; } }
            function addInteraction(type) {
                removeDraw(); measureSource.clear();
                const drawType = type === 'area' ? 'Polygon' : 'LineString';
                draw = new ol.interaction.Draw({ source: measureSource, type: drawType });
                map.addInteraction(draw);
                draw.on('drawend', () => removeDraw());
            }

            function deactivateButtons() {
                document.querySelectorAll('.measure-buttons button').forEach(b => b.classList.remove('active'));
            }

            function activateButton(btn) {
                deactivateButtons();
                btn.classList.add('active');
            }

            document.getElementById('measureDistance').addEventListener('click', function () {
                activateButton(this);
                addInteraction('length');
            });

            document.getElementById('measureArea').addEventListener('click', function () {
                activateButton(this);
                addInteraction('area');
            });

            document.getElementById('clearMeasure').addEventListener('click', function () {
                measureSource.clear();
                removeDraw();
                deactivateButtons();
            });
        }

        function setMarkerPosition(lon, lat, pinname, pinlocation, pindesc, plankey, pinkey) {
            if (!mapReady) { pendingPositions.push({ lon, lat, pinname, pinlocation, pindesc, plankey, pinkey }); return; }

            const marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
                pinname, pinlocation, pindesc, plankey, pinkey
            });

            marker.setStyle(new ol.style.Style({
                image: new ol.style.Icon({ src: initialIcon, scale: initialIconScale, anchor: [0.5, 1], anchorXUnits: 'fraction', anchorYUnits: 'fraction' })
            }));

            vectorSource.addFeature(marker);
        }

        function setMultipleMarkers(positions) { positions.forEach(p => setMarkerPosition(p.lon, p.lat, p.pinname, p.pinlocation, p.pindesc, p.plankey, p.pinkey)); }

        function getMarkerCoordinates() {
            const features = vectorSource.getFeatures();
            return features.length ? JSON.stringify(features.map(f => { const c = ol.proj.toLonLat(f.getGeometry().getCoordinates()); return { lon: c[0], lat: c[1], pinkey: f.get('pinkey'), plankey: f.get('plankey') }; })) : null;
        }

        window.onload = function () {
            const sendButton = document.getElementById('sendButton');
            sendButton.addEventListener('click', function () {
                if (!currentPinkey || !currentPlankey) return;
                const payload = { pinkey: currentPinkey, plankey: currentPlankey };
                if (window.jsBridge && typeof window.jsBridge.invokeAction === 'function') window.jsBridge.invokeAction(JSON.stringify(payload));
                else if (window.chrome?.webview && typeof window.chrome.webview.postMessage === 'function') window.chrome.webview.postMessage(JSON.stringify(payload));
                else alert("Bridge noch nicht verfügbar!");
            });
        };
    </script>
</body>
</html>